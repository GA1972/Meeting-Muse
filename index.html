<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Meeting Muse</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #1a1a1a;
            line-height: 1.5;
            font-weight: 400;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #ffffff;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 60px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: #1a1a1a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #6c757d;
        }
        
        .greeting {
            font-size: 48px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 40px;
            line-height: 1.2;
        }
        
        .auth-section {
            margin-bottom: 40px;
        }
        
        .auth-form {
            max-width: 400px;
        }
        
        .auth-form input {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 16px;
            background: #ffffff;
            transition: all 0.3s ease;
        }
        
        .auth-form input:focus {
            outline: none;
            border-color: #1a1a1a;
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1);
        }
        
        .btn {
            background: #1a1a1a;
            color: #ffffff;
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #343a40;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #dee2e6;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #1a1a1a;
            border: 1px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .user-info {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            display: none;
        }
        
        .user-info.active {
            display: block;
        }
        
        .admin-panel {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 16px;
            padding: 24px;
            margin-top: 16px;
            display: none;
        }
        
        .admin-panel.active {
            display: block;
        }
        
        .meetings-section {
            margin-bottom: 60px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 20px;
        }
        
        .meetings-table {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 16px;
            overflow: hidden;
        }
        
        .table-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: grid;
            grid-template-columns: 120px 1fr auto;
            gap: 20px;
            font-weight: 600;
            color: #6c757d;
            font-size: 14px;
        }
        
        .table-row {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
            display: grid;
            grid-template-columns: 120px 1fr auto;
            gap: 20px;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .table-row:hover {
            background: #f8f9fa;
        }
        
        .table-row:last-child {
            border-bottom: none;
        }
        
        .meeting-date {
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .meeting-title {
            color: #1a1a1a;
            font-weight: 500;
        }
        
        .chevron {
            color: #6c757d;
            font-size: 18px;
        }
        
        .action-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        
        .action-card {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            padding: 32px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 16px;
            line-height: 1.2;
        }
        
        .card-description {
            color: #6c757d;
            margin-bottom: 24px;
            line-height: 1.6;
        }
        
        .card-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 24px;
            color: #1a1a1a;
        }
        
        .card-button:hover {
            background: #1a1a1a;
            color: #ffffff;
        }
        
        .recording-interface {
            display: none;
            margin-top: 40px;
        }
        
        .recording-interface.active {
            display: block;
        }
        
        .recording-panel {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 24px;
        }
        
        .record-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            margin: 0 auto 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .record-button.idle {
            background: #1a1a1a;
            color: #ffffff;
        }
        
        .record-button.recording {
            background: #dc3545;
            color: #ffffff;
            animation: pulse 2s infinite;
        }
        
        .record-button.processing {
            background: #fd7e14;
            color: #ffffff;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .status {
            margin-bottom: 30px;
        }
        
        .status-text {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        
        .timer {
            font-size: 32px;
            font-weight: 300;
            color: #6c757d;
            font-family: 'SF Mono', monospace;
        }
        
        .audio-visualizer {
            height: 60px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 30px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            width: 100%;
            max-width: 300px;
        }
        
        .wave-bar {
            width: 4px;
            background: #1a1a1a;
            border-radius: 2px;
            transition: height 0.15s ease;
            height: 8px;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .notes-section {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            padding: 40px;
        }
        
        .notes-title {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
        }
        
        .transcript-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            min-height: 150px;
            font-family: 'SF Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #1a1a1a;
        }
        
        .summary-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
        }
        
        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 16px;
        }
        
        .action-items-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
        }
        
        .action-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .action-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .export-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: #ffffff;
            margin: 50px auto;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #1a1a1a;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #1a1a1a; }
        .notification.info { background: #17a2b8; }
        
        .app-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        @media (max-width: 768px) {
            .greeting {
                font-size: 32px;
            }
            
            .action-cards {
                grid-template-columns: 1fr;
            }
            
            .table-header,
            .table-row {
                grid-template-columns: 80px 1fr auto;
                gap: 12px;
            }
            
            .container {
                padding: 20px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">🎙️</div>
                <span>My Meeting Muse</span>
            </div>
            <div class="user-avatar" id="userAvatar">?</div>
        </div>
        
        <div class="greeting" id="greeting">Good morning, Guest</div>
        
        <div class="auth-section" id="authSection">
            <div class="auth-form" id="loginForm">
                <input type="email" id="userEmail" placeholder="Enter your email address">
                <button id="loginBtn" class="btn">Access Portal</button>
            </div>
            
            <div class="user-info" id="userInfo">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <span id="userName" style="font-weight: 600; font-size: 18px;"></span>
                        <span id="userRole" style="margin-left: 10px; padding: 4px 12px; background: #1a1a1a; color: white; border-radius: 12px; font-size: 12px;"></span>
                    </div>
                    <button id="logoutBtn" class="btn btn-secondary">Sign Out</button>
                </div>
                <div id="calendarStatus" style="color: #6c757d; font-size: 14px;"></div>
            </div>
            
            <div class="admin-panel" id="adminPanel">
                <strong style="font-size: 16px; margin-bottom: 16px; display: block;">Administrative Controls</strong>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button id="viewUsageBtn" class="btn btn-secondary">Usage Analytics</button>
                    <button id="manageUsersBtn" class="btn btn-secondary">Team Management</button>
                    <button id="settingsBtn" class="btn btn-secondary">Settings</button>
                </div>
            </div>
        </div>
        
        <div class="meetings-section" id="meetingsSection" style="display: none;">
            <h2 class="section-title">Upcoming meetings</h2>
            
            <div class="meetings-table">
                <div class="table-header">
                    <div>Date</div>
                    <div>Meeting</div>
                    <div></div>
                </div>
                <div id="meetingsList">
                    <div class="table-row" onclick="selectMeetingFromTable(0)">
                        <div class="meeting-date">Today</div>
                        <div class="meeting-title">Team Strategy Session</div>
                        <div class="chevron">›</div>
                    </div>
                    <div class="table-row" onclick="selectMeetingFromTable(1)">
                        <div class="meeting-date">Tomorrow</div>
                        <div class="meeting-title">Client Review Meeting</div>
                        <div class="chevron">›</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="action-cards" id="actionCards" style="display: none;">
            <div class="action-card" onclick="startRecording()">
                <div class="card-title">Create meeting</div>
                <div class="card-description">Generate agendas and talking points instantly</div>
                <div class="card-button">+</div>
            </div>
            
            <div class="action-card" onclick="showDashboard()">
                <div class="card-title">Dashboard</div>
                <div class="card-description">View and manage your scheduled meetings</div>
                <div class="card-button">📊</div>
            </div>
            
            <div class="action-card" onclick="showAdminTools()">
                <div class="card-title">Admin tools</div>
                <div class="card-description">Manage team members and settings</div>
                <div class="card-button">⚙️</div>
            </div>
        </div>
        
        <div class="recording-interface" id="recordingInterface">
            <div class="recording-panel">
                <button id="recordBtn" class="record-button idle">Record</button>
                
                <div class="status">
                    <div class="status-text" id="statusText">Ready to begin recording</div>
                    <div class="timer" id="timer">00:00</div>
                </div>
                
                <div class="audio-visualizer" id="visualizer">
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" id="pauseBtn" disabled>Pause</button>
                    <button class="btn btn-secondary" id="stopBtn" disabled>Stop</button>
                    <button class="btn btn-secondary" id="clearBtn">Clear</button>
                    <button class="btn btn-secondary" onclick="goBackToMain()">← Back</button>
                </div>
            </div>
            
            <div class="notes-section">
                <h3 class="notes-title">Live Transcript</h3>
                <div class="transcript-box" id="transcript">
                    Transcript will appear here during recording...
                </div>
                
                <h3 class="notes-title">AI Summary</h3>
                <div class="summary-box">
                    <h4 class="summary-title">Key Points</h4>
                    <div id="keySummary">Summary will be generated automatically...</div>
                </div>
                
                <div class="action-items-box">
                    <h4 class="summary-title">Action Items</h4>
                    <div id="actionItems">Action items will be extracted here...</div>
                </div>
                
                <div class="export-actions">
                    <button class="btn" id="exportBtn">Export Notes</button>
                    <button class="btn btn-secondary" id="downloadTranscript">Download Transcript</button>
                    <button class="btn btn-secondary" id="downloadAudio">Download Audio</button>
                    <button class="btn btn-secondary" id="shareNotes">Share</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="usageModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Usage Analytics</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <strong>Current Month</strong>
                <div style="margin-top: 10px;">
                    <div>Total Recordings: <strong>247</strong></div>
                    <div>Total Minutes: <strong>1,248 min</strong></div>
                    <div>API Calls: <strong>8,945</strong></div>
                    <div>Cost: <strong>$23.67</strong></div>
                </div>
            </div>
            <button onclick="closeModal('usageModal')" class="btn">Close</button>
        </div>
    </div>

    <div id="usersModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Team Management</h2>
            <div style="margin-bottom: 20px;">
                <input type="email" id="newUserEmail" placeholder="Add team member email" 
                       style="width: 70%; padding: 12px; margin-right: 10px; border: 1px solid #dee2e6; border-radius: 8px;">
                <button onclick="addUser()" class="btn">Add</button>
            </div>
            <button onclick="closeModal('usersModal')" class="btn">Close</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Settings</h2>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px;"><strong>Recording Quality:</strong></label>
                <select style="padding: 12px; border: 1px solid #dee2e6; border-radius: 8px;">
                    <option>Standard (16kHz)</option>
                    <option selected>High (44kHz)</option>
                    <option>Ultra (96kHz)</option>
                </select>
            </div>
            <button onclick="saveSettings()" class="btn" style="margin-right: 10px;">Save</button>
            <button onclick="closeModal('settingsModal')" class="btn btn-secondary">Cancel</button>
        </div>
    </div>

    <script>
        // Global variables
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let isPaused = false;
        let startTime = 0;
        let timerInterval = null;
        let audioContext = null;
        let analyser = null;
        let animationId = null;

        let currentUser = null;
        let isAuthenticated = false;
        let currentMeetings = [];

        // Sample data for fallback only
        const sampleActions = [
            "Follow up on discussed topics",
            "Schedule next team meeting", 
            "Review action items from today"
        ];

        const demoMeetings = [
            {
                id: '1',
                summary: 'Team Strategy Session',
                organizer: { displayName: 'You' },
                attendees: [
                    { displayName: 'Sarah Marketing' },
                    { displayName: 'John Development' },
                    { displayName: 'Lisa Operations' }
                ],
                start: { dateTime: new Date(Date.now() + 15 * 60000).toISOString() },
                end: { dateTime: new Date(Date.now() + 75 * 60000).toISOString() },
            },
            {
                id: '2',
                summary: 'Client Review Meeting',
                organizer: { displayName: 'You' },
                attendees: [
                    { displayName: 'Client Representative' },
                    { displayName: 'Account Manager' }
                ],
                start: { dateTime: new Date(Date.now() + 24 * 60 * 60000).toISOString() },
                end: { dateTime: new Date(Date.now() + 25 * 60 * 60000).toISOString() },
            }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            updateGreeting();
        }

        function setupEventListeners() {
            // Auth events
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('userEmail').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });

            // Recording events
            document.getElementById('recordBtn').addEventListener('click', toggleRecording);
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
            document.getElementById('stopBtn').addEventListener('click', stopRecording);
            document.getElementById('clearBtn').addEventListener('click', clearSession);

            // Export events
            document.getElementById('exportBtn').addEventListener('click', exportNotes);
            document.getElementById('downloadTranscript').addEventListener('click', downloadTranscriptFile);
            document.getElementById('downloadAudio').addEventListener('click', downloadAudioFile);
            document.getElementById('shareNotes').addEventListener('click', generateShareLink);

            // Admin events
            document.getElementById('viewUsageBtn').addEventListener('click', () => openModal('usageModal'));
            document.getElementById('manageUsersBtn').addEventListener('click', () => openModal('usersModal'));
            document.getElementById('settingsBtn').addEventListener('click', () => openModal('settingsModal'));

            // Modal events
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
        }

        function updateGreeting() {
            const hour = new Date().getHours();
            const greeting = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
            const name = currentUser ? currentUser.name : 'Guest';
            document.getElementById('greeting').textContent = `${greeting}, ${name}`;
            
            if (currentUser) {
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            }
        }

        function handleLogin() {
            const email = document.getElementById('userEmail').value.trim();
            
            if (!email) {
                showNotification('Please enter your email address', 'error');
                return;
            }

            const loginBtn = document.getElementById('loginBtn');
            loginBtn.textContent = 'Authenticating...';
            loginBtn.disabled = true;
            
            setTimeout(() => {
                currentUser = {
                    email: email,
                    name: email.split('@')[0].replace('.', ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    isAdmin: email.includes('admin') || email.includes('gieve')
                };
                
                isAuthenticated = true;
                updateAuthUI();
                showMainInterface();
                updateGreeting();
                
                showNotification(`Welcome, ${currentUser.name}!`, 'success');
            }, 1500);
        }

        function handleLogout() {
            if (isRecording) {
                if (!confirm('Recording is in progress. Are you sure you want to logout?')) {
                    return;
                }
                stopRecording();
            }

            currentUser = null;
            isAuthenticated = false;
            updateAuthUI();
            hideMainInterface();
            updateGreeting();
            showNotification('Logged out successfully', 'info');
        }

        function updateAuthUI() {
            const loginForm = document.getElementById('loginForm');
            const userInfo = document.getElementById('userInfo');
            const adminPanel = document.getElementById('adminPanel');
            
            if (isAuthenticated && currentUser) {
                loginForm.style.display = 'none';
                userInfo.classList.add('active');
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userRole').textContent = currentUser.isAdmin ? 'Admin' : 'User';
                
                if (currentUser.isAdmin) {
                    adminPanel.classList.add('active');
                }
            } else {
                loginForm.style.display = 'block';
                userInfo.classList.remove('active');
                adminPanel.classList.remove('active');
                document.getElementById('userEmail').value = '';
                document.getElementById('loginBtn').textContent = 'Access Portal';
                document.getElementById('loginBtn').disabled = false;
            }
        }

        function showMainInterface() {
            document.getElementById('meetingsSection').style.display = 'block';
            document.getElementById('actionCards').style.display = 'grid';
            loadMeetings(); // 🔒 Now calls secure API
        }

        function hideMainInterface() {
            document.getElementById('meetingsSection').style.display = 'none';
            document.getElementById('actionCards').style.display = 'none';
            document.getElementById('recordingInterface').classList.remove('active');
        }

        // Remove the old demo functions and replace with API calls
        function simulateLiveTranscript() {
            // Real-time transcription would use WebSocket or streaming API
            // For now, just show a placeholder during recording
            document.getElementById('transcript').textContent = 'Recording in progress... Transcript will appear after processing.';
        }

        function generateAISummary() {
            // This is now handled in processRecordingWithAPI()
            // Keep as placeholder for any additional processing
        }

        function processRecording() {
            // This is now handled by processRecordingWithAPI()
            // The MediaRecorder onstop event calls processRecordingWithAPI()
        }

        function selectMeetingFromTable(index) {
            if (!isAuthenticated) {
                showNotification('Please login first', 'error');
                return;
            }
            
            const meeting = currentMeetings[index];
            showNotification(`Selected: ${meeting.summary}`, 'success');
            startRecording();
        }

        function startRecording() {
            if (!isAuthenticated) {
                showNotification('Please login first', 'error');
                return;
            }
            
            document.getElementById('recordingInterface').classList.add('active');
            document.getElementById('actionCards').style.display = 'none';
            document.getElementById('meetingsSection').style.display = 'none';
        }

        function goBackToMain() {
            if (isRecording) {
                if (!confirm('Recording is in progress. Are you sure you want to go back?')) {
                    return;
                }
                stopRecording();
            }
            
            document.getElementById('recordingInterface').classList.remove('active');
            document.getElementById('actionCards').style.display = 'grid';
            document.getElementById('meetingsSection').style.display = 'block';
        }

        function showDashboard() {
            showNotification('Loading dashboard...', 'info');
            // Future: Implement dashboard with meeting history, analytics, etc.
        }

        // Remove old demo functions - now using secure APIs
        // simulateLiveTranscript, generateAISummary, processRecording are replaced

        // Recording functions - SECURE API INTEGRATION
        async function toggleRecording() {
            if (!isRecording) {
                await startRecordingProcess();
            } else {
                stopRecording();
            }
        }

        async function startRecordingProcess() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = processRecordingWithAPI;
                mediaRecorder.start(1000);
                
                isRecording = true;
                startTime = Date.now();
                
                updateRecordingUI();
                startTimer();
                startVisualizer(stream);
                
                showNotification('Recording started', 'success');
                
            } catch (error) {
                console.error('Error starting recording:', error);
                let errorMessage = 'Failed to start recording';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Microphone access denied. Please allow microphone access.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No microphone found. Please connect a microphone.';
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        // SECURE: Process recording with API validation
        async function processRecordingWithAPI() {
            try {
                if (!audioChunks || audioChunks.length === 0) {
                    showNotification('No audio data to process', 'warning');
                    return;
                }

                document.getElementById('statusText').textContent = 'Processing audio...';
                document.getElementById('recordBtn').className = 'record-button processing';

                // Convert audio to base64 for API
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioBase64 = await blobToBase64(audioBlob);

                // 🔒 SECURE API CALL: Transcription with domain validation
                const transcriptResponse = await fetch('/api/transcribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userEmail: currentUser.email, // 🔒 Domain checked server-side
                        audioData: audioBase64.split(',')[1] // Remove data:audio/wav;base64, prefix
                    })
                });

                if (!transcriptResponse.ok) {
                    const error = await transcriptResponse.json();
                    throw new Error(error.error || 'Transcription failed');
                }

                const transcriptData = await transcriptResponse.json();
                document.getElementById('transcript').textContent = transcriptData.transcript;

                // 🔒 SECURE API CALL: AI Summary with domain validation
                document.getElementById('statusText').textContent = 'Generating AI summary...';
                
                const summaryResponse = await fetch('/api/summarize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userEmail: currentUser.email, // 🔒 Domain checked server-side
                        transcript: transcriptData.transcript,
                        meetingTitle: 'Team Meeting' // Could be dynamic
                    })
                });

                if (!summaryResponse.ok) {
                    const error = await summaryResponse.json();
                    throw new Error(error.error || 'AI summary failed');
                }

                const summaryData = await summaryResponse.json();
                const analysis = summaryData.analysis;

                // Update UI with AI results
                document.getElementById('keySummary').textContent = analysis.summary;
                
                const actionItemsDiv = document.getElementById('actionItems');
                actionItemsDiv.innerHTML = '';
                
                if (analysis.actionItems && Array.isArray(analysis.actionItems)) {
                    analysis.actionItems.forEach((action, index) => {
                        const actionDiv = document.createElement('div');
                        actionDiv.className = 'action-item';
                        actionDiv.innerHTML = `
                            <input type="checkbox" id="action${index}">
                            <label for="action${index}">${action}</label>
                        `;
                        actionItemsDiv.appendChild(actionDiv);
                    });
                }

                document.getElementById('statusText').textContent = 'Processing complete';
                document.getElementById('recordBtn').className = 'record-button idle';
                
                showNotification('Meeting processed successfully!', 'success');
                
            } catch (error) {
                console.error('❌ Processing error:', error);
                
                // Show user-friendly error
                document.getElementById('statusText').textContent = 'Processing failed';
                document.getElementById('recordBtn').className = 'record-button idle';
                
                if (error.message.includes('Rate limit')) {
                    showNotification('Rate limit exceeded. Please wait before processing another recording.', 'warning');
                } else if (error.message.includes('Access denied')) {
                    showNotification('Access denied. Please ensure you\'re using an @anr.in email.', 'error');
                } else {
                    showNotification('Processing failed. Please try again.', 'error');
                }
            }
        }

        // Helper function to convert blob to base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // SECURE: Load meetings from API
        async function loadMeetings() {
            if (!currentUser) return;

            try {
                const response = await fetch(`/api/calendar?userEmail=${encodeURIComponent(currentUser.email)}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load meetings');
                }

                const data = await response.json();
                currentMeetings = data.meetings;
                
                // Update meetings table
                const meetingsList = document.getElementById('meetingsList');
                meetingsList.innerHTML = '';
                
                currentMeetings.forEach((meeting, index) => {
                    const startTime = new Date(meeting.start.dateTime);
                    const timeLabel = isToday(startTime) ? 'Today' : 
                                     isTomorrow(startTime) ? 'Tomorrow' : 
                                     startTime.toLocaleDateString();
                    
                    const meetingRow = document.createElement('div');
                    meetingRow.className = 'table-row';
                    meetingRow.onclick = () => selectMeetingFromTable(index);
                    meetingRow.innerHTML = `
                        <div class="meeting-date">${timeLabel}</div>
                        <div class="meeting-title">${meeting.summary}</div>
                        <div class="chevron">›</div>
                    `;
                    meetingsList.appendChild(meetingRow);
                });
                
            } catch (error) {
                console.error('❌ Calendar error:', error);
                showNotification('Failed to load calendar meetings', 'warning');
                // Fall back to demo data
                currentMeetings = demoMeetings;
            }
        }

        // Helper functions for date checking
        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function isTomorrow(date) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return date.toDateString() === tomorrow.toDateString();
        }

        // SECURE: Admin usage analytics
        async function showAdminTools() {
            if (!currentUser?.isAdmin) {
                showNotification('Admin access required', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/usage?userEmail=${encodeURIComponent(currentUser.email)}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load analytics');
                }

                const data = await response.json();
                const analytics = data.analytics;
                
                // Update usage modal with real data
                const usageModal = document.getElementById('usageModal');
                const modalContent = usageModal.querySelector('.modal-content');
                
                modalContent.innerHTML = `
                    <h2 class="modal-title">Usage Analytics Dashboard</h2>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <strong>Current Statistics</strong>
                        <div style="margin-top: 10px;">
                            <div>Total Requests: <strong>${analytics.totalRequests}</strong></div>
                            <div>Active Users: <strong>${analytics.activeUsers}</strong></div>
                            <div>Total API Cost: <strong>${analytics.totalCost}</strong></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>User Activity:</strong>
                        ${analytics.users.map(user => `
                            <div style="display: flex; justify-content: space-between; padding: 10px; border: 1px solid #dee2e6; border-radius: 8px; margin: 5px 0;">
                                <span>${user.email}</span>
                                <span>${user.requests} requests | ${user.cost}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button onclick="closeModal('usageModal')" class="btn">Close Dashboard</button>
                `;
                
                openModal('usageModal');
                
            } catch (error) {
                console.error('❌ Analytics error:', error);
                showNotification('Failed to load usage analytics', 'error');
            }
        }

        function togglePause() {
            if (!mediaRecorder || !isRecording) return;
            
            if (!isPaused) {
                mediaRecorder.pause();
                isPaused = true;
                document.getElementById('pauseBtn').textContent = 'Resume';
                document.getElementById('statusText').textContent = 'Recording paused';
                showNotification('Recording paused', 'warning');
            } else {
                mediaRecorder.resume();
                isPaused = false;
                document.getElementById('pauseBtn').textContent = 'Pause';
                document.getElementById('statusText').textContent = 'Recording in progress';
                showNotification('Recording resumed', 'success');
            }
        }

        function stopRecording() {
            if (!mediaRecorder || !isRecording) return;
            
            try {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                isPaused = false;
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                
                updateRecordingUI();
                showNotification('Recording stopped', 'info');
                setTimeout(generateAISummary, 1000);
                
            } catch (error) {
                console.error('Error stopping recording:', error);
                showNotification('Error stopping recording', 'error');
            }
        }

        function clearSession() {
            if (isRecording) {
                if (!confirm('Recording is in progress. Clear session?')) return;
                stopRecording();
            }

            document.getElementById('transcript').textContent = 'Transcript will appear here during recording...';
            document.getElementById('keySummary').textContent = 'Summary will be generated automatically...';
            document.getElementById('actionItems').textContent = 'Action items will be extracted here...';
            document.getElementById('timer').textContent = '00:00';
            document.getElementById('statusText').textContent = 'Ready to begin recording';
            
            audioChunks = [];
            showNotification('Session cleared', 'info');
        }

        function updateRecordingUI() {
            const recordBtn = document.getElementById('recordBtn');
            const statusText = document.getElementById('statusText');
            const pauseBtn = document.getElementById('pauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (isRecording) {
                recordBtn.className = 'record-button recording';
                recordBtn.textContent = 'Stop';
                statusText.textContent = isPaused ? 'Recording paused' : 'Recording in progress';
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
            } else {
                recordBtn.className = 'record-button idle';
                recordBtn.textContent = 'Record';
                statusText.textContent = 'Ready to begin recording';
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = 'Pause';
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                if (!isPaused && isRecording) {
                    const elapsed = Date.now() - startTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    document.getElementById('timer').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function startVisualizer(stream) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                analyser.fftSize = 64;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const waveBars = document.querySelectorAll('.wave-bar');
                
                function animate() {
                    if (isRecording && !isPaused) {
                        analyser.getByteFrequencyData(dataArray);
                        
                        waveBars.forEach((bar, index) => {
                            const height = Math.max(8, (dataArray[index * 2] || 0) / 255 * 40);
                            bar.style.height = `${height}px`;
                        });
                    }
                    
                    if (isRecording) {
                        animationId = requestAnimationFrame(animate);
                    }
                }
                
                animate();
            } catch (error) {
                console.error('Error starting visualizer:', error);
            }
        }

        function simulateLiveTranscript() {
            const words = sampleTranscript.split(' ');
            let currentIndex = 0;
            document.getElementById('transcript').textContent = '';
            
            const interval = setInterval(() => {
                if (!isRecording || isPaused || currentIndex >= words.length) {
                    clearInterval(interval);
                    return;
                }
                
                const transcript = document.getElementById('transcript');
                transcript.textContent += words[currentIndex] + ' ';
                currentIndex++;
                transcript.scrollTop = transcript.scrollHeight;
            }, 150);
        }

        function generateAISummary() {
            document.getElementById('statusText').textContent = 'Processing with AI...';
            document.getElementById('recordBtn').className = 'record-button processing';
            
            setTimeout(() => {
                try {
                    document.getElementById('keySummary').textContent = sampleSummary;
                    
                    const actionItemsDiv = document.getElementById('actionItems');
                    actionItemsDiv.innerHTML = '';
                    sampleActions.forEach((action, index) => {
                        const actionDiv = document.createElement('div');
                        actionDiv.className = 'action-item';
                        actionDiv.innerHTML = `
                            <input type="checkbox" id="action${index}">
                            <label for="action${index}">${action}</label>
                        `;
                        actionItemsDiv.appendChild(actionDiv);
                    });
                    
                    document.getElementById('statusText').textContent = 'Processing complete';
                    document.getElementById('recordBtn').className = 'record-button idle';
                    
                    showNotification('AI summary generated successfully', 'success');
                } catch (error) {
                    console.error('Error generating summary:', error);
                    showNotification('Failed to generate AI summary', 'error');
                }
            }, 2500);
        }

        function processRecording() {
            try {
                const audioBlob = new Blob(audioChunks, { 
                    type: mediaRecorder.mimeType || 'audio/wav' 
                });
                console.log('Audio processed:', audioBlob);
            } catch (error) {
                console.error('Error processing recording:', error);
            }
        }

        // Export functions
        function exportNotes() {
            try {
                const notes = {
                    transcript: document.getElementById('transcript').textContent,
                    summary: document.getElementById('keySummary').textContent,
                    actionItems: sampleActions,
                    exportedBy: currentUser?.email || 'unknown',
                    exportedAt: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(notes, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `meeting-notes-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('Notes exported successfully', 'success');
            } catch (error) {
                showNotification('Failed to export notes', 'error');
            }
        }

        function downloadTranscriptFile() {
            try {
                const transcriptContent = document.getElementById('transcript').textContent;
                if (!transcriptContent || transcriptContent.includes('Transcript will appear')) {
                    showNotification('No transcript available', 'warning');
                    return;
                }

                const content = `MEETING TRANSCRIPT
==================

${transcriptContent}

---
Generated by My Meeting Muse
Export Date: ${new Date().toLocaleString()}
`;

                const blob = new Blob([content], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `transcript-${Date.now()}.txt`;
                link.click();
                
                showNotification('Transcript downloaded', 'success');
            } catch (error) {
                showNotification('Failed to download transcript', 'error');
            }
        }

        function downloadAudioFile() {
            try {
                if (!audioChunks || audioChunks.length === 0) {
                    showNotification('No audio recording available', 'warning');
                    return;
                }

                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(audioBlob);
                link.download = `recording-${Date.now()}.wav`;
                link.click();
                
                showNotification('Audio downloaded', 'success');
            } catch (error) {
                showNotification('Failed to download audio', 'error');
            }
        }

        function generateShareLink() {
            try {
                const shareUrl = `https://my-meeting-muse.vercel.app/shared/${Date.now()}`;
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        showNotification('Share link copied to clipboard!', 'success');
                    }).catch(() => {
                        fallbackCopyToClipboard(shareUrl);
                    });
                } else {
                    fallbackCopyToClipboard(shareUrl);
                }
            } catch (error) {
                showNotification('Failed to generate share link', 'error');
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('Share link copied!', 'success');
            } catch (err) {
                showNotification('Please copy link manually: ' + text, 'info');
            }
            document.body.removeChild(textArea);
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function addUser() {
            const email = document.getElementById('newUserEmail')?.value.trim();
            if (!email) {
                showNotification('Please enter an email address', 'warning');
                return;
            }
            showNotification(`User ${email} added successfully!`, 'success');
            document.getElementById('newUserEmail').value = '';
        }

        function saveSettings() {
            showNotification('Settings saved successfully!', 'success');
            closeModal('settingsModal');
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
